<h1>Conditionally Writeable Attributes</h1><p>While designing an event system for a personal project, I ran across a requirement which I knew could be implemented elegantly with Raku&#39;s metaprogramming capabilities. Specifically, I wanted both sync and async events, with the sync events allowing mutation of fields (e.g. for cancellation), and the async ones being merely informational and thus immutable.</p><p>First, I needed an <code>Event</code> role to group eventy behavior and <a href="https://docs.raku.org/language/typesystem#trait_does">be inherited</a> by all the event classes. Then, choosing <a href="https://docs.raku.org/syntax/Mixins">mixins</a> over inheritance, I decided that sync and async would also be roles (<code>Sync</code> and <code>Async</code>) <em>not</em> related to <code>Event</code> in the type hierarchy, but rather mixed into instances of <code>Event</code>&#39;s inheritors as appropriate.</p><pre id="advent-code-1cfbfed7-640d-4ce7-8e9a-f8274e0f4642" style="border: 1px dotted #ddd; background: none; border-radius: 3px; padding: 10px;"><table class="highlight tab-size js-file-line-container js-code-nav-container js-tagsearch-file" data-hpc data-paste-markdown-skip data-tab-size="8" data-tagsearch-lang="Raku" data-tagsearch-path="1cfbfed7-640d-4ce7-8e9a-f8274e0f4642.p6" style="background: none; padding: 0; margin: 0">
        <tr style="background: none; padding: 0; margin: 0">
          <td class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="1" id="file-1cfbfed7-640d-4ce7-8e9a-f8274e0f4642-p6-L1" style="border: 0; padding: 0; background: none"></td>
          <td class="blob-code blob-code-inner js-file-line" id="file-1cfbfed7-640d-4ce7-8e9a-f8274e0f4642-p6-LC1" style="border: 0; padding: 0; background: none"><span class="pl-c" style="color: #6a737d"><span class="pl-c" style="color: #6a737d">#</span> no relations between these types!</span></td>
        </tr>
        <tr style="background: none; padding: 0; margin: 0">
          <td class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="2" id="file-1cfbfed7-640d-4ce7-8e9a-f8274e0f4642-p6-L2" style="border: 0; padding: 0; background: none"></td>
          <td class="blob-code blob-code-inner js-file-line" id="file-1cfbfed7-640d-4ce7-8e9a-f8274e0f4642-p6-LC2" style="border: 0; padding: 0; background: none"><span class="pl-k" style="color: #d73a49">role</span> <span class="pl-en" style="color: #6f42c1">Event</span> <span class="pl-k" style="color: #d73a49">is</span> <span class="pl-en" style="color: #6f42c1">export</span> {}</td>
        </tr>
        <tr style="background: none; padding: 0; margin: 0">
          <td class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="3" id="file-1cfbfed7-640d-4ce7-8e9a-f8274e0f4642-p6-L3" style="border: 0; padding: 0; background: none"></td>
          <td class="blob-code blob-code-inner js-file-line" id="file-1cfbfed7-640d-4ce7-8e9a-f8274e0f4642-p6-LC3" style="border: 0; padding: 0; background: none"><span class="pl-k" style="color: #d73a49">role</span> <span class="pl-en" style="color: #6f42c1">Sync</span> <span class="pl-k" style="color: #d73a49">is</span> <span class="pl-en" style="color: #6f42c1">export</span> {}</td>
        </tr>
        <tr style="background: none; padding: 0; margin: 0">
          <td class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="4" id="file-1cfbfed7-640d-4ce7-8e9a-f8274e0f4642-p6-L4" style="border: 0; padding: 0; background: none"></td>
          <td class="blob-code blob-code-inner js-file-line" id="file-1cfbfed7-640d-4ce7-8e9a-f8274e0f4642-p6-LC4" style="border: 0; padding: 0; background: none"><span class="pl-k" style="color: #d73a49">role</span> <span class="pl-en" style="color: #6f42c1">Async</span> <span class="pl-k" style="color: #d73a49">is</span> <span class="pl-en" style="color: #6f42c1">export</span> {}</td>
        </tr>
  </table></pre><p>Using mixins for the sync/async distinction here eliminates the need to write two versions of each event class, one doing a theoretical <code>SyncEvent</code> role and the other a theoretical <code>AsyncEvent</code> role (which would in turn both do the <code>Event</code> god-role). Instead, we write the inheriting class once and reuse it—a much cleaner design!</p><p>However, this presents the issue indicated in the topic. Because sync—but <em>not</em> async—events are meant to be mutable by event handlers, how do we write each event class once yet have differing behavior without duplicating logic in every method (shown below)? After all, the <code>Sync</code> and <code>Async</code> roles cannot have advance knowledge of the exact structure of what they&#39;ll be mixed into, so <em>they</em> can&#39;t provide the differentiating functionality.</p><pre id="advent-code-993b3208-1fa6-4400-bc67-0cf22e70b847" style="border: 1px dotted #ddd; background: none; border-radius: 3px; padding: 10px;"><table class="highlight tab-size js-file-line-container js-code-nav-container js-tagsearch-file" data-hpc data-paste-markdown-skip data-tab-size="8" data-tagsearch-lang="Raku" data-tagsearch-path="993b3208-1fa6-4400-bc67-0cf22e70b847.p6" style="background: none; padding: 0; margin: 0">
        <tr style="background: none; padding: 0; margin: 0">
          <td class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="1" id="file-993b3208-1fa6-4400-bc67-0cf22e70b847-p6-L1" style="border: 0; padding: 0; background: none"></td>
          <td class="blob-code blob-code-inner js-file-line" id="file-993b3208-1fa6-4400-bc67-0cf22e70b847-p6-LC1" style="border: 0; padding: 0; background: none"><span class="pl-k" style="color: #d73a49">class</span> <span class="pl-en" style="color: #6f42c1">ConfigLoadEvent</span> <span class="pl-k" style="color: #d73a49">does</span> Event {</td>
        </tr>
        <tr style="background: none; padding: 0; margin: 0">
          <td class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="2" id="file-993b3208-1fa6-4400-bc67-0cf22e70b847-p6-L2" style="border: 0; padding: 0; background: none"></td>
          <td class="blob-code blob-code-inner js-file-line" id="file-993b3208-1fa6-4400-bc67-0cf22e70b847-p6-LC2" style="border: 0; padding: 0; background: none">    <span class="pl-k" style="color: #d73a49">has</span> <span class="pl-c1" style="color: #005cc5">Int</span> <span class="pl-smi" style="color: #24292e">$</span><span class="pl-c1" style="color: #005cc5">!</span><span class="pl-smi" style="color: #24292e">timeout</span>;</td>
        </tr>
        <tr style="background: none; padding: 0; margin: 0">
          <td class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="3" id="file-993b3208-1fa6-4400-bc67-0cf22e70b847-p6-L3" style="border: 0; padding: 0; background: none"></td>
          <td class="blob-code blob-code-inner js-file-line" id="file-993b3208-1fa6-4400-bc67-0cf22e70b847-p6-LC3" style="border: 0; padding: 0; background: none">
</td>
        </tr>
        <tr style="background: none; padding: 0; margin: 0">
          <td class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="4" id="file-993b3208-1fa6-4400-bc67-0cf22e70b847-p6-L4" style="border: 0; padding: 0; background: none"></td>
          <td class="blob-code blob-code-inner js-file-line" id="file-993b3208-1fa6-4400-bc67-0cf22e70b847-p6-LC4" style="border: 0; padding: 0; background: none">    <span class="pl-c" style="color: #6a737d"><span class="pl-c" style="color: #6a737d">#</span> Horribly tedious!</span></td>
        </tr>
        <tr style="background: none; padding: 0; margin: 0">
          <td class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="5" id="file-993b3208-1fa6-4400-bc67-0cf22e70b847-p6-L5" style="border: 0; padding: 0; background: none"></td>
          <td class="blob-code blob-code-inner js-file-line" id="file-993b3208-1fa6-4400-bc67-0cf22e70b847-p6-LC5" style="border: 0; padding: 0; background: none">    <span class="pl-k" style="color: #d73a49">method</span> <span class="pl-en" style="color: #6f42c1">get-timeout</span> { <span class="pl-smi" style="color: #24292e">$</span><span class="pl-c1" style="color: #005cc5">!</span><span class="pl-smi" style="color: #24292e">timeout</span>; }</td>
        </tr>
        <tr style="background: none; padding: 0; margin: 0">
          <td class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="6" id="file-993b3208-1fa6-4400-bc67-0cf22e70b847-p6-L6" style="border: 0; padding: 0; background: none"></td>
          <td class="blob-code blob-code-inner js-file-line" id="file-993b3208-1fa6-4400-bc67-0cf22e70b847-p6-LC6" style="border: 0; padding: 0; background: none">    <span class="pl-k" style="color: #d73a49">method</span> <span class="pl-en" style="color: #6f42c1">set-timeout</span>(<span class="pl-c1" style="color: #005cc5">Int</span> <span class="pl-smi" style="color: #24292e">$</span><span class="pl-smi" style="color: #24292e">timeout</span>) {</td>
        </tr>
        <tr style="background: none; padding: 0; margin: 0">
          <td class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="7" id="file-993b3208-1fa6-4400-bc67-0cf22e70b847-p6-L7" style="border: 0; padding: 0; background: none"></td>
          <td class="blob-code blob-code-inner js-file-line" id="file-993b3208-1fa6-4400-bc67-0cf22e70b847-p6-LC7" style="border: 0; padding: 0; background: none">        <span class="pl-k" style="color: #d73a49">fail</span> <span class="pl-k" style="color: #d73a49">unless</span> <span class="pl-c1" style="color: #005cc5">self</span> <span class="pl-k" style="color: #d73a49">~~</span> Sync;</td>
        </tr>
        <tr style="background: none; padding: 0; margin: 0">
          <td class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="8" id="file-993b3208-1fa6-4400-bc67-0cf22e70b847-p6-L8" style="border: 0; padding: 0; background: none"></td>
          <td class="blob-code blob-code-inner js-file-line" id="file-993b3208-1fa6-4400-bc67-0cf22e70b847-p6-LC8" style="border: 0; padding: 0; background: none">        <span class="pl-smi" style="color: #24292e">$</span><span class="pl-c1" style="color: #005cc5">!</span><span class="pl-smi" style="color: #24292e">timeout</span> <span class="pl-k" style="color: #d73a49">=</span> <span class="pl-smi" style="color: #24292e">$</span><span class="pl-smi" style="color: #24292e">timeout</span>;</td>
        </tr>
        <tr style="background: none; padding: 0; margin: 0">
          <td class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="9" id="file-993b3208-1fa6-4400-bc67-0cf22e70b847-p6-L9" style="border: 0; padding: 0; background: none"></td>
          <td class="blob-code blob-code-inner js-file-line" id="file-993b3208-1fa6-4400-bc67-0cf22e70b847-p6-LC9" style="border: 0; padding: 0; background: none">    }</td>
        </tr>
        <tr style="background: none; padding: 0; margin: 0">
          <td class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="10" id="file-993b3208-1fa6-4400-bc67-0cf22e70b847-p6-L10" style="border: 0; padding: 0; background: none"></td>
          <td class="blob-code blob-code-inner js-file-line" id="file-993b3208-1fa6-4400-bc67-0cf22e70b847-p6-LC10" style="border: 0; padding: 0; background: none">}</td>
        </tr>
  </table></pre><p>The solution is a type-aware (specifically mixin-aware) <a href="https://docs.raku.org/language/traits">trait</a> which I decided to name <code>sync-rw</code>. This will be applied to attributes of the various classes doing the <code>Event</code> role which have some data that sync handlers can change but which ought not to be touched by async handlers.</p><p>Like Raku&#39;s built-in <code>rw</code> trait, this trait allows us to run some code at compile time to alter runtime behavior in and around language object we applied said trait to. &quot;Language object&quot; could mean subroutine, class, method, parameter, and so on. In this case, we want a trait specifically for use with object attributes,<sup><a id="ref1" href="#ref1-detail">1</a></sup> i.e., stuff declared with the <a href="https://docs.raku.org/language/variables#The_has_declarator"><code>has</code> declarator</a>.</p><p>With that said, what precisely <em>should</em> <code>sync-rw</code> do to the attribute? Actually, nothing. That wasn&#39;t a trick question, either: the fact is, we needn&#39;t change anything about the attribute itself, rather the code that gets generated for the class <em>containing</em> the attribute.</p><p>For those unfamiliar, Raku generates an accessor for you when you use the <code>.</code> <a href="https://docs.raku.org/language/classtut#Attributes">twigil</a> on an attribute, as shown below. By default, this accessor returns a readonly container. With the <code>rw</code> trait, it returns a writeable container, again as demonstrated below. Note that when I say &quot;accessor&quot; I don&#39;t mean anything special at a language level; I just mean a method that happens to provide access to an attribute. This results in what <em>looks</em> like direct attribute access à la C structs but is in fact a method call whose name happens to match the attribute name and which happens to give you access to the attribute.</p><pre id="advent-code-367b3eb0-af40-4b84-91a1-e1f34e9a2851" style="border: 1px dotted #ddd; background: none; border-radius: 3px; padding: 10px;"><table class="highlight tab-size js-file-line-container js-code-nav-container js-tagsearch-file" data-hpc data-paste-markdown-skip data-tab-size="8" data-tagsearch-lang="Raku" data-tagsearch-path="367b3eb0-af40-4b84-91a1-e1f34e9a2851.p6" style="background: none; padding: 0; margin: 0">
        <tr style="background: none; padding: 0; margin: 0">
          <td class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="1" id="file-367b3eb0-af40-4b84-91a1-e1f34e9a2851-p6-L1" style="border: 0; padding: 0; background: none"></td>
          <td class="blob-code blob-code-inner js-file-line" id="file-367b3eb0-af40-4b84-91a1-e1f34e9a2851-p6-LC1" style="border: 0; padding: 0; background: none"><span class="pl-k" style="color: #d73a49">class</span> <span class="pl-en" style="color: #6f42c1">Foo</span> {</td>
        </tr>
        <tr style="background: none; padding: 0; margin: 0">
          <td class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="2" id="file-367b3eb0-af40-4b84-91a1-e1f34e9a2851-p6-L2" style="border: 0; padding: 0; background: none"></td>
          <td class="blob-code blob-code-inner js-file-line" id="file-367b3eb0-af40-4b84-91a1-e1f34e9a2851-p6-LC2" style="border: 0; padding: 0; background: none">    <span class="pl-k" style="color: #d73a49">has</span> <span class="pl-smi" style="color: #24292e">$</span><span class="pl-c1" style="color: #005cc5">!</span><span class="pl-smi" style="color: #24292e">secret</span>; <span class="pl-c" style="color: #6a737d"><span class="pl-c" style="color: #6a737d">#</span> no accessor</span></td>
        </tr>
        <tr style="background: none; padding: 0; margin: 0">
          <td class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="3" id="file-367b3eb0-af40-4b84-91a1-e1f34e9a2851-p6-L3" style="border: 0; padding: 0; background: none"></td>
          <td class="blob-code blob-code-inner js-file-line" id="file-367b3eb0-af40-4b84-91a1-e1f34e9a2851-p6-LC3" style="border: 0; padding: 0; background: none">    <span class="pl-k" style="color: #d73a49">has</span> <span class="pl-smi" style="color: #24292e">$</span><span class="pl-c1" style="color: #005cc5">.</span><span class="pl-smi" style="color: #24292e">bar</span>;</td>
        </tr>
        <tr style="background: none; padding: 0; margin: 0">
          <td class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="4" id="file-367b3eb0-af40-4b84-91a1-e1f34e9a2851-p6-L4" style="border: 0; padding: 0; background: none"></td>
          <td class="blob-code blob-code-inner js-file-line" id="file-367b3eb0-af40-4b84-91a1-e1f34e9a2851-p6-LC4" style="border: 0; padding: 0; background: none">    <span class="pl-k" style="color: #d73a49">has</span> <span class="pl-smi" style="color: #24292e">$</span><span class="pl-c1" style="color: #005cc5">.</span><span class="pl-smi" style="color: #24292e">baz</span> <span class="pl-k" style="color: #d73a49">is</span> <span class="pl-en" style="color: #6f42c1">rw</span>;</td>
        </tr>
        <tr style="background: none; padding: 0; margin: 0">
          <td class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="5" id="file-367b3eb0-af40-4b84-91a1-e1f34e9a2851-p6-L5" style="border: 0; padding: 0; background: none"></td>
          <td class="blob-code blob-code-inner js-file-line" id="file-367b3eb0-af40-4b84-91a1-e1f34e9a2851-p6-LC5" style="border: 0; padding: 0; background: none">}</td>
        </tr>
        <tr style="background: none; padding: 0; margin: 0">
          <td class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="6" id="file-367b3eb0-af40-4b84-91a1-e1f34e9a2851-p6-L6" style="border: 0; padding: 0; background: none"></td>
          <td class="blob-code blob-code-inner js-file-line" id="file-367b3eb0-af40-4b84-91a1-e1f34e9a2851-p6-LC6" style="border: 0; padding: 0; background: none"><span class="pl-k" style="color: #d73a49">my</span> Foo <span class="pl-smi" style="color: #24292e">$</span><span class="pl-smi" style="color: #24292e">foo</span> <span class="pl-k" style="color: #d73a49">.=</span> <span class="pl-c1" style="color: #005cc5">new</span><span class="pl-k" style="color: #d73a49">:</span> <span class="pl-k" style="color: #d73a49">:</span><span class="pl-c1" style="color: #005cc5">2</span>bar, <span class="pl-k" style="color: #d73a49">:</span><span class="pl-c1" style="color: #005cc5">2</span>baz;</td>
        </tr>
        <tr style="background: none; padding: 0; margin: 0">
          <td class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="7" id="file-367b3eb0-af40-4b84-91a1-e1f34e9a2851-p6-L7" style="border: 0; padding: 0; background: none"></td>
          <td class="blob-code blob-code-inner js-file-line" id="file-367b3eb0-af40-4b84-91a1-e1f34e9a2851-p6-LC7" style="border: 0; padding: 0; background: none"><span class="pl-c1" style="color: #005cc5">say</span> <span class="pl-smi" style="color: #24292e">$</span><span class="pl-smi" style="color: #24292e">foo</span><span class="pl-k" style="color: #d73a49">.</span>bar;</td>
        </tr>
        <tr style="background: none; padding: 0; margin: 0">
          <td class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="8" id="file-367b3eb0-af40-4b84-91a1-e1f34e9a2851-p6-L8" style="border: 0; padding: 0; background: none"></td>
          <td class="blob-code blob-code-inner js-file-line" id="file-367b3eb0-af40-4b84-91a1-e1f34e9a2851-p6-LC8" style="border: 0; padding: 0; background: none"><span class="pl-smi" style="color: #24292e">$</span><span class="pl-smi" style="color: #24292e">foo</span><span class="pl-k" style="color: #d73a49">.</span>baz <span class="pl-k" style="color: #d73a49">=</span> <span class="pl-c1" style="color: #005cc5">3</span>;</td>
        </tr>
        <tr style="background: none; padding: 0; margin: 0">
          <td class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="9" id="file-367b3eb0-af40-4b84-91a1-e1f34e9a2851-p6-L9" style="border: 0; padding: 0; background: none"></td>
          <td class="blob-code blob-code-inner js-file-line" id="file-367b3eb0-af40-4b84-91a1-e1f34e9a2851-p6-LC9" style="border: 0; padding: 0; background: none"><span class="pl-c1" style="color: #005cc5">say</span> <span class="pl-smi" style="color: #24292e">$</span><span class="pl-smi" style="color: #24292e">foo</span><span class="pl-k" style="color: #d73a49">.</span>baz(); <span class="pl-c" style="color: #6a737d"><span class="pl-c" style="color: #6a737d">#</span> parens to demonstrate this is a method</span></td>
        </tr>
  </table></pre><p>This ability to return a writeable container is not unique to code generated for classes by the compiler. You, the user, can get this functionality with <a href="https://docs.raku.org/syntax/return-rw"><code>return-rw</code></a>. That and the <a href="https://docs.raku.org/language/mop">Metaobject Protocol</a> (MOP) are about all we need to write our <code>sync-rw</code> trait.</p><pre id="advent-code-49b1cf8e-b6d6-42f0-8dbf-19b646143e43" style="border: 1px dotted #ddd; background: none; border-radius: 3px; padding: 10px;"><table class="highlight tab-size js-file-line-container js-code-nav-container js-tagsearch-file" data-hpc data-paste-markdown-skip data-tab-size="8" data-tagsearch-lang="Raku" data-tagsearch-path="49b1cf8e-b6d6-42f0-8dbf-19b646143e43.p6" style="background: none; padding: 0; margin: 0">
        <tr style="background: none; padding: 0; margin: 0">
          <td class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="1" id="file-49b1cf8e-b6d6-42f0-8dbf-19b646143e43-p6-L1" style="border: 0; padding: 0; background: none"></td>
          <td class="blob-code blob-code-inner js-file-line" id="file-49b1cf8e-b6d6-42f0-8dbf-19b646143e43-p6-LC1" style="border: 0; padding: 0; background: none"><span class="pl-k" style="color: #d73a49">multi</span> <span class="pl-en" style="color: #6f42c1">trait_mod</span>:&lt;<span class="pl-s" style="color: #032f62">is</span>&gt;(<span class="pl-c1" style="color: #005cc5">Attribute</span> <span class="pl-smi" style="color: #24292e">$</span><span class="pl-smi" style="color: #24292e">attr</span>, <span class="pl-k" style="color: #d73a49">:</span><span class="pl-smi" style="color: #24292e">$</span><span class="pl-smi" style="color: #24292e">sync-rw</span><span class="pl-k" style="color: #d73a49">!</span>) <span class="pl-k" style="color: #d73a49">is</span> <span class="pl-en" style="color: #6f42c1">export</span> {</td>
        </tr>
        <tr style="background: none; padding: 0; margin: 0">
          <td class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="2" id="file-49b1cf8e-b6d6-42f0-8dbf-19b646143e43-p6-L2" style="border: 0; padding: 0; background: none"></td>
          <td class="blob-code blob-code-inner js-file-line" id="file-49b1cf8e-b6d6-42f0-8dbf-19b646143e43-p6-LC2" style="border: 0; padding: 0; background: none">    <span class="pl-smi" style="color: #24292e">$</span><span class="pl-smi" style="color: #24292e">attr</span><span class="pl-k" style="color: #d73a49">.</span>package<span class="pl-k" style="color: #d73a49">.^</span>add_method<span class="pl-k" style="color: #d73a49">:</span></td>
        </tr>
        <tr style="background: none; padding: 0; margin: 0">
          <td class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="3" id="file-49b1cf8e-b6d6-42f0-8dbf-19b646143e43-p6-L3" style="border: 0; padding: 0; background: none"></td>
          <td class="blob-code blob-code-inner js-file-line" id="file-49b1cf8e-b6d6-42f0-8dbf-19b646143e43-p6-LC3" style="border: 0; padding: 0; background: none">        <span class="pl-smi" style="color: #24292e">$</span><span class="pl-smi" style="color: #24292e">attr</span><span class="pl-k" style="color: #d73a49">.</span><span class="pl-c1" style="color: #005cc5">name</span><span class="pl-k" style="color: #d73a49">.</span><span class="pl-c1" style="color: #005cc5">substr</span>(<span class="pl-c1" style="color: #005cc5">2</span>),</td>
        </tr>
        <tr style="background: none; padding: 0; margin: 0">
          <td class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="4" id="file-49b1cf8e-b6d6-42f0-8dbf-19b646143e43-p6-L4" style="border: 0; padding: 0; background: none"></td>
          <td class="blob-code blob-code-inner js-file-line" id="file-49b1cf8e-b6d6-42f0-8dbf-19b646143e43-p6-LC4" style="border: 0; padding: 0; background: none">        anon <span class="pl-k" style="color: #d73a49">method</span> :: {</td>
        </tr>
        <tr style="background: none; padding: 0; margin: 0">
          <td class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="5" id="file-49b1cf8e-b6d6-42f0-8dbf-19b646143e43-p6-L5" style="border: 0; padding: 0; background: none"></td>
          <td class="blob-code blob-code-inner js-file-line" id="file-49b1cf8e-b6d6-42f0-8dbf-19b646143e43-p6-LC5" style="border: 0; padding: 0; background: none">            <span class="pl-k" style="color: #d73a49">if</span> <span class="pl-c1" style="color: #005cc5">self</span> <span class="pl-k" style="color: #d73a49">~~</span> Sync {</td>
        </tr>
        <tr style="background: none; padding: 0; margin: 0">
          <td class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="6" id="file-49b1cf8e-b6d6-42f0-8dbf-19b646143e43-p6-L6" style="border: 0; padding: 0; background: none"></td>
          <td class="blob-code blob-code-inner js-file-line" id="file-49b1cf8e-b6d6-42f0-8dbf-19b646143e43-p6-LC6" style="border: 0; padding: 0; background: none">                <span class="pl-k" style="color: #d73a49">return-rw</span> <span class="pl-smi" style="color: #24292e">$</span><span class="pl-smi" style="color: #24292e">attr</span><span class="pl-k" style="color: #d73a49">.</span>get_value<span class="pl-k" style="color: #d73a49">:</span> <span class="pl-c1" style="color: #005cc5">self</span>;</td>
        </tr>
        <tr style="background: none; padding: 0; margin: 0">
          <td class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="7" id="file-49b1cf8e-b6d6-42f0-8dbf-19b646143e43-p6-L7" style="border: 0; padding: 0; background: none"></td>
          <td class="blob-code blob-code-inner js-file-line" id="file-49b1cf8e-b6d6-42f0-8dbf-19b646143e43-p6-LC7" style="border: 0; padding: 0; background: none">            }</td>
        </tr>
        <tr style="background: none; padding: 0; margin: 0">
          <td class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="8" id="file-49b1cf8e-b6d6-42f0-8dbf-19b646143e43-p6-L8" style="border: 0; padding: 0; background: none"></td>
          <td class="blob-code blob-code-inner js-file-line" id="file-49b1cf8e-b6d6-42f0-8dbf-19b646143e43-p6-LC8" style="border: 0; padding: 0; background: none">            <span class="pl-k" style="color: #d73a49">elsif</span> <span class="pl-c1" style="color: #005cc5">self</span> <span class="pl-k" style="color: #d73a49">~~</span> Async {</td>
        </tr>
        <tr style="background: none; padding: 0; margin: 0">
          <td class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="9" id="file-49b1cf8e-b6d6-42f0-8dbf-19b646143e43-p6-L9" style="border: 0; padding: 0; background: none"></td>
          <td class="blob-code blob-code-inner js-file-line" id="file-49b1cf8e-b6d6-42f0-8dbf-19b646143e43-p6-LC9" style="border: 0; padding: 0; background: none">                <span class="pl-k" style="color: #d73a49">return</span> <span class="pl-smi" style="color: #24292e">$</span><span class="pl-smi" style="color: #24292e">attr</span><span class="pl-k" style="color: #d73a49">.</span>get_value<span class="pl-k" style="color: #d73a49">:</span> <span class="pl-c1" style="color: #005cc5">self</span>;</td>
        </tr>
        <tr style="background: none; padding: 0; margin: 0">
          <td class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="10" id="file-49b1cf8e-b6d6-42f0-8dbf-19b646143e43-p6-L10" style="border: 0; padding: 0; background: none"></td>
          <td class="blob-code blob-code-inner js-file-line" id="file-49b1cf8e-b6d6-42f0-8dbf-19b646143e43-p6-LC10" style="border: 0; padding: 0; background: none">            }</td>
        </tr>
        <tr style="background: none; padding: 0; margin: 0">
          <td class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="11" id="file-49b1cf8e-b6d6-42f0-8dbf-19b646143e43-p6-L11" style="border: 0; padding: 0; background: none"></td>
          <td class="blob-code blob-code-inner js-file-line" id="file-49b1cf8e-b6d6-42f0-8dbf-19b646143e43-p6-LC11" style="border: 0; padding: 0; background: none">            <span class="pl-k" style="color: #d73a49">else</span> {</td>
        </tr>
        <tr style="background: none; padding: 0; margin: 0">
          <td class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="12" id="file-49b1cf8e-b6d6-42f0-8dbf-19b646143e43-p6-L12" style="border: 0; padding: 0; background: none"></td>
          <td class="blob-code blob-code-inner js-file-line" id="file-49b1cf8e-b6d6-42f0-8dbf-19b646143e43-p6-LC12" style="border: 0; padding: 0; background: none">                <span class="pl-k" style="color: #d73a49">die</span> <span class="pl-s" style="color: #032f62"><span class="pl-pds" style="color: #032f62">&quot;</span><span class="pl-pse">{</span> <span class="pl-c1" style="color: #005cc5">self</span><span class="pl-k" style="color: #d73a49">.^</span><span class="pl-c1" style="color: #005cc5">name</span> <span class="pl-pse">}</span> with attributes marked `is sync-rw`<span class="pl-pds" style="color: #032f62">&quot;</span></span></td>
        </tr>
        <tr style="background: none; padding: 0; margin: 0">
          <td class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="13" id="file-49b1cf8e-b6d6-42f0-8dbf-19b646143e43-p6-L13" style="border: 0; padding: 0; background: none"></td>
          <td class="blob-code blob-code-inner js-file-line" id="file-49b1cf8e-b6d6-42f0-8dbf-19b646143e43-p6-LC13" style="border: 0; padding: 0; background: none">                    <span class="pl-k" style="color: #d73a49">~</span> <span class="pl-s" style="color: #032f62"><span class="pl-pds" style="color: #032f62">&#39;</span> must have either Sync or Async mixed in<span class="pl-pds" style="color: #032f62">&#39;</span></span>;</td>
        </tr>
        <tr style="background: none; padding: 0; margin: 0">
          <td class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="14" id="file-49b1cf8e-b6d6-42f0-8dbf-19b646143e43-p6-L14" style="border: 0; padding: 0; background: none"></td>
          <td class="blob-code blob-code-inner js-file-line" id="file-49b1cf8e-b6d6-42f0-8dbf-19b646143e43-p6-LC14" style="border: 0; padding: 0; background: none">            }</td>
        </tr>
        <tr style="background: none; padding: 0; margin: 0">
          <td class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="15" id="file-49b1cf8e-b6d6-42f0-8dbf-19b646143e43-p6-L15" style="border: 0; padding: 0; background: none"></td>
          <td class="blob-code blob-code-inner js-file-line" id="file-49b1cf8e-b6d6-42f0-8dbf-19b646143e43-p6-LC15" style="border: 0; padding: 0; background: none">        };</td>
        </tr>
        <tr style="background: none; padding: 0; margin: 0">
          <td class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="16" id="file-49b1cf8e-b6d6-42f0-8dbf-19b646143e43-p6-L16" style="border: 0; padding: 0; background: none"></td>
          <td class="blob-code blob-code-inner js-file-line" id="file-49b1cf8e-b6d6-42f0-8dbf-19b646143e43-p6-LC16" style="border: 0; padding: 0; background: none">}</td>
        </tr>
  </table></pre><p>Let&#39;s break down this code. First, <code>trait_mod:&lt;is&gt;</code> is how we refer to the <code>is</code> pseudo-operator.<sup><a id="ref2" href="#ref2-detail">2</a></sup> We&#39;re using a multi here because there are already built-in definitions for <code>is</code>, and we want to add another candidate. This candidate takes an <a href="https://docs.raku.org/type/Attribute"><code>Attribute</code></a> (a meta-class representing an object attribute) as its left-hand argument and the bare term <code>sync-rw</code> as its right-hand argument. The colon makes <code>$sync-rw</code> a <a href="https://docs.raku.org/language/signatures#Positional_vs._named_arguments">named parameter</a>, which normally we would pass with a colon on the caller side, but <code>is</code> has some syntax sugaring, so we needn&#39;t write <code>is :sync-rw</code>. The exclamation makes it required (named params are optional by default).</p><p>We&#39;re exporting this routine because we want it available to other code units. (Yes, <a href="https://docs.raku.org/type/Mu#trait_is_export"><code>export</code> is also a trait</a>!) Looking at the body of the routine, our first line gets the package in which the <code>Attribute</code> lives, which will be the class that <code>has</code> the attribute. We use a meta-method call (indicated by the carat) to <a href="https://docs.raku.org/routine/add_method">add a method</a> to that class. Another way of saying &quot;meta-method call&quot; is &quot;method call on the object&#39;s <a href="https://docs.raku.org/type/Metamodel/ClassHOW">meta representation</a>.&quot;</p><p>The first parameter for <code>add_method</code> is the new method&#39;s name. We take <code>$attr</code>&#39;s name, strip the first two characters (which will be the sigil and twigil like <code>$.</code>), and use that for the method name. Just like the built-in accessor we get from the <code>.</code> twigil, this will make the generated method&#39;s name match the attribute name.</p><p>If Raku generates a method, and we&#39;re also generating a method with the same name, will the two code generation processes interfere? Nope. Raku&#39;s built-in accessor generation only happens if there is not already a method defined with that name, allowing the user to define a custom accessor (or method which does something entirely different) without it getting steamrolled. The way we&#39;re defining the method here is out of the ordinary, but the result is the same, and Raku will refrain from generating the default accessor.</p><p>The second parameter is an anonymous method object. The <a href="https://docs.raku.org/syntax/anon"><code>anon</code> declarator</a> prevents the symbol from being installed in any scope or symbol table. The root package <code>::</code> is used in place of a name. While you can give <code>anon method</code>s a name (which only the method itself would know), we don&#39;t need or want a proper name here.</p><p>The body of the method checks to see whether the invocant (<code>self</code>, the object on which the method will be called at runtime) is <code>Sync</code>, <code>Async</code>, or neither. If it&#39;s <code>Sync</code>, we <code>return-rw</code>; if it&#39;s <code>Async</code>, we do a regular <code>return</code>; and if it&#39;s neither, we generate an error.</p><p>We retrieve the actual value with <code>$attr.get_value: self</code>. It needs to be passed the <code>self</code> instance because <code>Attribute</code>s represent a part of your code. They know what class they&#39;re in, but they&#39;re at a <em>class</em> (or <em>package</em>) level, not an <em>instance</em> level. Once we give it the instance, <code>$attr</code> knows how to retrieve the relevant value from that instance.</p><p>As an aside, we don&#39;t strictly need the <code>Event</code> role for this minimized example. For the real thing, we can and should check inside our <code>trait_mod:&lt;is&gt;</code> candidate that the attribute&#39;s package (class) <code>does</code> the <code>Event</code> role, throwing an error otherwise.</p><p>And that&#39;s all the code we need. I spent a while explaining the why and how, but the final volume of code is barely over a dozen significant lines. For a task that delves into metaprogramming, Raku gets us to the solution shockingly fast and with nearly zero boilerplate code.</p><p>Now, we&#39;ll throw the role and trait definitions together in an <code>Event.rakumod</code> file so we can test it with the below <code>.rakutest</code> file.</p><pre id="advent-code-03631abb-29e5-4731-8d8e-708a8d16f0d0" style="border: 1px dotted #ddd; background: none; border-radius: 3px; padding: 10px;"><table class="highlight tab-size js-file-line-container js-code-nav-container js-tagsearch-file" data-hpc data-paste-markdown-skip data-tab-size="8" data-tagsearch-lang="Raku" data-tagsearch-path="03631abb-29e5-4731-8d8e-708a8d16f0d0.p6" style="background: none; padding: 0; margin: 0">
        <tr style="background: none; padding: 0; margin: 0">
          <td class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="1" id="file-03631abb-29e5-4731-8d8e-708a8d16f0d0-p6-L1" style="border: 0; padding: 0; background: none"></td>
          <td class="blob-code blob-code-inner js-file-line" id="file-03631abb-29e5-4731-8d8e-708a8d16f0d0-p6-LC1" style="border: 0; padding: 0; background: none"><span class="pl-k" style="color: #d73a49">use</span> <span class="pl-c1" style="color: #005cc5">v6.d</span>;</td>
        </tr>
        <tr style="background: none; padding: 0; margin: 0">
          <td class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="2" id="file-03631abb-29e5-4731-8d8e-708a8d16f0d0-p6-L2" style="border: 0; padding: 0; background: none"></td>
          <td class="blob-code blob-code-inner js-file-line" id="file-03631abb-29e5-4731-8d8e-708a8d16f0d0-p6-LC2" style="border: 0; padding: 0; background: none"><span class="pl-k" style="color: #d73a49">use</span> <span class="pl-c1" style="color: #005cc5">Test</span>;</td>
        </tr>
        <tr style="background: none; padding: 0; margin: 0">
          <td class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="3" id="file-03631abb-29e5-4731-8d8e-708a8d16f0d0-p6-L3" style="border: 0; padding: 0; background: none"></td>
          <td class="blob-code blob-code-inner js-file-line" id="file-03631abb-29e5-4731-8d8e-708a8d16f0d0-p6-LC3" style="border: 0; padding: 0; background: none">
</td>
        </tr>
        <tr style="background: none; padding: 0; margin: 0">
          <td class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="4" id="file-03631abb-29e5-4731-8d8e-708a8d16f0d0-p6-L4" style="border: 0; padding: 0; background: none"></td>
          <td class="blob-code blob-code-inner js-file-line" id="file-03631abb-29e5-4731-8d8e-708a8d16f0d0-p6-LC4" style="border: 0; padding: 0; background: none"><span class="pl-k" style="color: #d73a49">use</span> <span class="pl-c1" style="color: #005cc5">lib</span> <span class="pl-s" style="color: #032f62"><span class="pl-pds" style="color: #032f62">&#39;</span>.<span class="pl-pds" style="color: #032f62">&#39;</span></span>;</td>
        </tr>
        <tr style="background: none; padding: 0; margin: 0">
          <td class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="5" id="file-03631abb-29e5-4731-8d8e-708a8d16f0d0-p6-L5" style="border: 0; padding: 0; background: none"></td>
          <td class="blob-code blob-code-inner js-file-line" id="file-03631abb-29e5-4731-8d8e-708a8d16f0d0-p6-LC5" style="border: 0; padding: 0; background: none"><span class="pl-k" style="color: #d73a49">use</span> Event;</td>
        </tr>
        <tr style="background: none; padding: 0; margin: 0">
          <td class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="6" id="file-03631abb-29e5-4731-8d8e-708a8d16f0d0-p6-L6" style="border: 0; padding: 0; background: none"></td>
          <td class="blob-code blob-code-inner js-file-line" id="file-03631abb-29e5-4731-8d8e-708a8d16f0d0-p6-LC6" style="border: 0; padding: 0; background: none">
</td>
        </tr>
        <tr style="background: none; padding: 0; margin: 0">
          <td class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="7" id="file-03631abb-29e5-4731-8d8e-708a8d16f0d0-p6-L7" style="border: 0; padding: 0; background: none"></td>
          <td class="blob-code blob-code-inner js-file-line" id="file-03631abb-29e5-4731-8d8e-708a8d16f0d0-p6-LC7" style="border: 0; padding: 0; background: none"><span class="pl-k" style="color: #d73a49">class</span> <span class="pl-en" style="color: #6f42c1">Foo</span> <span class="pl-k" style="color: #d73a49">does</span> Event {</td>
        </tr>
        <tr style="background: none; padding: 0; margin: 0">
          <td class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="8" id="file-03631abb-29e5-4731-8d8e-708a8d16f0d0-p6-L8" style="border: 0; padding: 0; background: none"></td>
          <td class="blob-code blob-code-inner js-file-line" id="file-03631abb-29e5-4731-8d8e-708a8d16f0d0-p6-LC8" style="border: 0; padding: 0; background: none">    <span class="pl-k" style="color: #d73a49">has</span> <span class="pl-smi" style="color: #24292e">$</span><span class="pl-c1" style="color: #005cc5">.</span><span class="pl-smi" style="color: #24292e">attr</span> <span class="pl-k" style="color: #d73a49">is</span> sync-rw;</td>
        </tr>
        <tr style="background: none; padding: 0; margin: 0">
          <td class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="9" id="file-03631abb-29e5-4731-8d8e-708a8d16f0d0-p6-L9" style="border: 0; padding: 0; background: none"></td>
          <td class="blob-code blob-code-inner js-file-line" id="file-03631abb-29e5-4731-8d8e-708a8d16f0d0-p6-LC9" style="border: 0; padding: 0; background: none">}</td>
        </tr>
        <tr style="background: none; padding: 0; margin: 0">
          <td class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="10" id="file-03631abb-29e5-4731-8d8e-708a8d16f0d0-p6-L10" style="border: 0; padding: 0; background: none"></td>
          <td class="blob-code blob-code-inner js-file-line" id="file-03631abb-29e5-4731-8d8e-708a8d16f0d0-p6-LC10" style="border: 0; padding: 0; background: none">
</td>
        </tr>
        <tr style="background: none; padding: 0; margin: 0">
          <td class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="11" id="file-03631abb-29e5-4731-8d8e-708a8d16f0d0-p6-L11" style="border: 0; padding: 0; background: none"></td>
          <td class="blob-code blob-code-inner js-file-line" id="file-03631abb-29e5-4731-8d8e-708a8d16f0d0-p6-LC11" style="border: 0; padding: 0; background: none"><span class="pl-c" style="color: #6a737d"><span class="pl-c" style="color: #6a737d">#</span> The value can be updated when the instance is Sync</span></td>
        </tr>
        <tr style="background: none; padding: 0; margin: 0">
          <td class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="12" id="file-03631abb-29e5-4731-8d8e-708a8d16f0d0-p6-L12" style="border: 0; padding: 0; background: none"></td>
          <td class="blob-code blob-code-inner js-file-line" id="file-03631abb-29e5-4731-8d8e-708a8d16f0d0-p6-LC12" style="border: 0; padding: 0; background: none"><span class="pl-k" style="color: #d73a49">my</span> <span class="pl-smi" style="color: #24292e">$</span><span class="pl-smi" style="color: #24292e">rw</span> <span class="pl-k" style="color: #d73a49">=</span> (Foo <span class="pl-k" style="color: #d73a49">but</span> Sync)<span class="pl-k" style="color: #d73a49">.</span><span class="pl-c1" style="color: #005cc5">new</span>(<span class="pl-s" style="color: #032f62">attr </span><span class="pl-k" style="color: #d73a49">=&gt;</span> <span class="pl-s" style="color: #032f62"><span class="pl-pds" style="color: #032f62">&#39;</span>old<span class="pl-pds" style="color: #032f62">&#39;</span></span>);</td>
        </tr>
        <tr style="background: none; padding: 0; margin: 0">
          <td class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="13" id="file-03631abb-29e5-4731-8d8e-708a8d16f0d0-p6-L13" style="border: 0; padding: 0; background: none"></td>
          <td class="blob-code blob-code-inner js-file-line" id="file-03631abb-29e5-4731-8d8e-708a8d16f0d0-p6-LC13" style="border: 0; padding: 0; background: none"><span class="pl-c1" style="color: #005cc5">lives-ok</span>  { <span class="pl-smi" style="color: #24292e">$</span><span class="pl-smi" style="color: #24292e">rw</span><span class="pl-k" style="color: #d73a49">.</span><span class="pl-c1" style="color: #005cc5">attr</span> <span class="pl-k" style="color: #d73a49">=</span> <span class="pl-s" style="color: #032f62"><span class="pl-pds" style="color: #032f62">&#39;</span>new<span class="pl-pds" style="color: #032f62">&#39;</span></span> };</td>
        </tr>
        <tr style="background: none; padding: 0; margin: 0">
          <td class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="14" id="file-03631abb-29e5-4731-8d8e-708a8d16f0d0-p6-L14" style="border: 0; padding: 0; background: none"></td>
          <td class="blob-code blob-code-inner js-file-line" id="file-03631abb-29e5-4731-8d8e-708a8d16f0d0-p6-LC14" style="border: 0; padding: 0; background: none"><span class="pl-c1" style="color: #005cc5">ok</span> <span class="pl-smi" style="color: #24292e">$</span><span class="pl-smi" style="color: #24292e">rw</span><span class="pl-k" style="color: #d73a49">.</span><span class="pl-c1" style="color: #005cc5">attr</span> <span class="pl-k" style="color: #d73a49">eq</span> <span class="pl-s" style="color: #032f62"><span class="pl-pds" style="color: #032f62">&#39;</span>new<span class="pl-pds" style="color: #032f62">&#39;</span></span>;</td>
        </tr>
        <tr style="background: none; padding: 0; margin: 0">
          <td class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="15" id="file-03631abb-29e5-4731-8d8e-708a8d16f0d0-p6-L15" style="border: 0; padding: 0; background: none"></td>
          <td class="blob-code blob-code-inner js-file-line" id="file-03631abb-29e5-4731-8d8e-708a8d16f0d0-p6-LC15" style="border: 0; padding: 0; background: none">
</td>
        </tr>
        <tr style="background: none; padding: 0; margin: 0">
          <td class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="16" id="file-03631abb-29e5-4731-8d8e-708a8d16f0d0-p6-L16" style="border: 0; padding: 0; background: none"></td>
          <td class="blob-code blob-code-inner js-file-line" id="file-03631abb-29e5-4731-8d8e-708a8d16f0d0-p6-LC16" style="border: 0; padding: 0; background: none"><span class="pl-c" style="color: #6a737d"><span class="pl-c" style="color: #6a737d">#</span> But not when Async</span></td>
        </tr>
        <tr style="background: none; padding: 0; margin: 0">
          <td class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="17" id="file-03631abb-29e5-4731-8d8e-708a8d16f0d0-p6-L17" style="border: 0; padding: 0; background: none"></td>
          <td class="blob-code blob-code-inner js-file-line" id="file-03631abb-29e5-4731-8d8e-708a8d16f0d0-p6-LC17" style="border: 0; padding: 0; background: none"><span class="pl-k" style="color: #d73a49">my</span> <span class="pl-smi" style="color: #24292e">$</span><span class="pl-smi" style="color: #24292e">non-rw</span> <span class="pl-k" style="color: #d73a49">=</span> (Foo <span class="pl-k" style="color: #d73a49">but</span> Async)<span class="pl-k" style="color: #d73a49">.</span><span class="pl-c1" style="color: #005cc5">new</span>(<span class="pl-s" style="color: #032f62">attr </span><span class="pl-k" style="color: #d73a49">=&gt;</span> <span class="pl-s" style="color: #032f62"><span class="pl-pds" style="color: #032f62">&#39;</span>old<span class="pl-pds" style="color: #032f62">&#39;</span></span>);</td>
        </tr>
        <tr style="background: none; padding: 0; margin: 0">
          <td class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="18" id="file-03631abb-29e5-4731-8d8e-708a8d16f0d0-p6-L18" style="border: 0; padding: 0; background: none"></td>
          <td class="blob-code blob-code-inner js-file-line" id="file-03631abb-29e5-4731-8d8e-708a8d16f0d0-p6-LC18" style="border: 0; padding: 0; background: none"><span class="pl-c1" style="color: #005cc5">throws-like</span> { <span class="pl-smi" style="color: #24292e">$</span><span class="pl-smi" style="color: #24292e">non-rw</span><span class="pl-k" style="color: #d73a49">.</span><span class="pl-c1" style="color: #005cc5">attr</span> <span class="pl-k" style="color: #d73a49">=</span> <span class="pl-s" style="color: #032f62"><span class="pl-pds" style="color: #032f62">&#39;</span>new<span class="pl-pds" style="color: #032f62">&#39;</span></span>; }, <span class="pl-c1" style="color: #005cc5">X::AdHoc</span>,</td>
        </tr>
        <tr style="background: none; padding: 0; margin: 0">
          <td class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="19" id="file-03631abb-29e5-4731-8d8e-708a8d16f0d0-p6-L19" style="border: 0; padding: 0; background: none"></td>
          <td class="blob-code blob-code-inner js-file-line" id="file-03631abb-29e5-4731-8d8e-708a8d16f0d0-p6-LC19" style="border: 0; padding: 0; background: none">    <span class="pl-s" style="color: #032f62">message </span><span class="pl-k" style="color: #d73a49">=&gt;</span> <span class="pl-s" style="color: #032f62"><span class="pl-pds" style="color: #032f62">&#39;</span>Cannot assign to a readonly variable or a value<span class="pl-pds" style="color: #032f62">&#39;</span></span>;</td>
        </tr>
        <tr style="background: none; padding: 0; margin: 0">
          <td class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="20" id="file-03631abb-29e5-4731-8d8e-708a8d16f0d0-p6-L20" style="border: 0; padding: 0; background: none"></td>
          <td class="blob-code blob-code-inner js-file-line" id="file-03631abb-29e5-4731-8d8e-708a8d16f0d0-p6-LC20" style="border: 0; padding: 0; background: none">
</td>
        </tr>
        <tr style="background: none; padding: 0; margin: 0">
          <td class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="21" id="file-03631abb-29e5-4731-8d8e-708a8d16f0d0-p6-L21" style="border: 0; padding: 0; background: none"></td>
          <td class="blob-code blob-code-inner js-file-line" id="file-03631abb-29e5-4731-8d8e-708a8d16f0d0-p6-LC21" style="border: 0; padding: 0; background: none"><span class="pl-c1" style="color: #005cc5">throws-like</span> { Foo<span class="pl-k" style="color: #d73a49">.</span><span class="pl-c1" style="color: #005cc5">new</span>(<span class="pl-s" style="color: #032f62">attr </span><span class="pl-k" style="color: #d73a49">=&gt;</span> <span class="pl-s" style="color: #032f62"><span class="pl-pds" style="color: #032f62">&#39;</span>invalid<span class="pl-pds" style="color: #032f62">&#39;</span></span>)<span class="pl-k" style="color: #d73a49">.</span><span class="pl-c1" style="color: #005cc5">attr</span>; }, <span class="pl-c1" style="color: #005cc5">X::AdHoc</span>,</td>
        </tr>
        <tr style="background: none; padding: 0; margin: 0">
          <td class="blob-num js-line-number js-code-nav-line-number js-blob-rnum" data-line-number="22" id="file-03631abb-29e5-4731-8d8e-708a8d16f0d0-p6-L22" style="border: 0; padding: 0; background: none"></td>
          <td class="blob-code blob-code-inner js-file-line" id="file-03631abb-29e5-4731-8d8e-708a8d16f0d0-p6-LC22" style="border: 0; padding: 0; background: none">    <span class="pl-s" style="color: #032f62">message </span><span class="pl-k" style="color: #d73a49">=&gt;</span> <span class="pl-s" style="color: #032f62"><span class="pl-pds" style="color: #032f62">&#39;</span>Foo with attributes marked `is sync-rw` must have either Sync or Async mixed in<span class="pl-pds" style="color: #032f62">&#39;</span></span>;</td>
        </tr>
  </table></pre><p>And there we have it! All the tests pass, and we have a generic solution which is easily reused and prevents a lot of nasty code duplication. One could argue that meta-object fiddling is nasty in itself, but it&#39;s O(1) nastiness compared to the O(n) nastiness that code duplication would be. In the end, I find this a rather elegant interface because it parallels Raku&#39;s built-in <code>rw</code> trait and requires so little effort on the usage side. Slap <code>is sync-rw</code> on and that&#39;s it.</p><p>Hopefully this serves as a lesson in language design, too. Such an elegant yet easy-to-implement solution is only possible because Raku exposes to the user (nearly) all the same tools the language designers have, with a concise and straightforward interface out of the box—no third-party tools needed. If you&#39;ve ever done reflection in Java, you&#39;ll understand how much there is to appreciate here.</p><p>Finally, I&#39;d like to give credit to guifa from the Raku IRC for the exact form of the trait code. Prior to their suggestion, I had something much messier because I didn&#39;t know what was available and how well things would DWIM. </p><p>[<a id="ref1-detail" href="#ref1">1</a>] The <code>rw</code> trait can also be applied in other places such as parameter declarations. </p><p>[<a id="ref2-detail" href="#ref2">2</a>] While you can treat <code>is</code> like an operator in some ways, such as adding a new candidate like we are here, it is special-cased because it needs to do special (compile-time) things.</p>
